
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>service.job.job_controller &#8212; Cilantro alpha documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for service.job.job_controller</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">jsonschema</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">g</span>

<span class="kn">from</span> <span class="nn">service.errors</span> <span class="k">import</span> <span class="n">ApiError</span>
<span class="kn">from</span> <span class="nn">utils.celery_client</span> <span class="k">import</span> <span class="n">celery_app</span>
<span class="kn">from</span> <span class="nn">service.job.job_config</span> <span class="k">import</span> <span class="n">JobConfig</span>
<span class="kn">from</span> <span class="nn">service.user.user_service</span> <span class="k">import</span> <span class="n">auth</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">job_db</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">json_validation</span>


<div class="viewcode-block" id="get_job_config"><a class="viewcode-back" href="../../../service.job.html#service.job.job_controller.get_job_config">[docs]</a><span class="k">def</span> <span class="nf">get_job_config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the job config singleton or creates it if it does not exist already.</span>

<span class="sd">    :return JobConfig:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">job_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_job_config&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">job_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_config</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">_job_config</span> <span class="o">=</span> <span class="n">JobConfig</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">job_config</span></div>


<span class="n">job_controller</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;job&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="job_list"><a class="viewcode-back" href="../../../service.job.html#service.job.job_controller.job_list">[docs]</a><span class="nd">@job_controller</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/jobs&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@auth</span><span class="o">.</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">job_list</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List jobs of the user.</span>

<span class="sd">    List jobs of the user updated less than a week ago and all jobs, which were</span>
<span class="sd">    not successful.</span>
<span class="sd">    If show_all_jobs is set True it returns all jobs.</span>

<span class="sd">    .. :quickref: Job Controller; List jobs of the user</span>

<span class="sd">    **Example request**:</span>

<span class="sd">    .. sourcecode:: http</span>

<span class="sd">        GET /jobs/ HTTP/1.1</span>

<span class="sd">    **Example response SUCCESS**:</span>

<span class="sd">    .. sourcecode:: http</span>

<span class="sd">        HTTP/1.1 200 OK</span>

<span class="sd">        [</span>
<span class="sd">            {</span>
<span class="sd">                &quot;created&quot;: &quot;Tue, 30 Oct 2018 14:06:32 GMT&quot;,</span>
<span class="sd">                &quot;errors&quot;: [],</span>
<span class="sd">                &quot;job_id&quot;: &quot;010819cc-dc4d-11e8-b152-0242ac130008&quot;,</span>
<span class="sd">                &quot;job_type&quot;: &quot;ingest_journal&quot;,</span>
<span class="sd">                &quot;name&quot;: &quot;JOB-ingest_journal-test.pdf&quot;</span>
<span class="sd">                &quot;state&quot;: &quot;success&quot;,</span>
<span class="sd">                &quot;task_ids&quot;: [</span>
<span class="sd">                    &quot;9331a617-d35f-4b1a-be24-ec7a970c480e&quot;,</span>
<span class="sd">                    &quot;f012ef11-1ac0-4810-986a-c31335b918fb&quot;,</span>
<span class="sd">                    &quot;628abc60-2767-484a-a5c3-0b5a9c1a1ef6&quot;,</span>
<span class="sd">                    &quot;c2a97fd1-28d2-4e97-b41f-67b6f70d91df&quot;,</span>
<span class="sd">                    &quot;85cd98a7-fe3f-4e42-91f8-504c074be263&quot;,</span>
<span class="sd">                    &quot;5af3a39c-f837-41df-8a5e-ecdc55a2bef6&quot;,</span>
<span class="sd">                    &quot;2576d860-b694-4d41-8190-092f45837c37&quot;,</span>
<span class="sd">                    &quot;8b7e956a-2fc1-446f-9cc8-9f1d63471b2a&quot;,</span>
<span class="sd">                    &quot;d2d337a7-f346-4b7e-b1f8-4ee4942716f5&quot;,</span>
<span class="sd">                    &quot;94304191-45fd-45f0-937c-02a6b13fb64c&quot;,</span>
<span class="sd">                    &quot;b283d505-4174-4a46-909a-1f742dad6047&quot;,</span>
<span class="sd">                    &quot;010819cc-dc4d-11e8-b152-0242ac130008&quot;</span>
<span class="sd">                ],</span>
<span class="sd">                &quot;updated&quot;: &quot;Tue, 30 Oct 2018 14:06:59 GMT&quot;,</span>
<span class="sd">                &quot;user&quot;: &quot;test_user&quot;</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                &quot;created&quot;: &quot;Tue, 30 Oct 2018 14:07:04 GMT&quot;,</span>
<span class="sd">                &quot;errors&quot;: [],</span>
<span class="sd">                &quot;job_id&quot;: &quot;147b74cc-dc4d-11e8-8db4-0242ac130008&quot;,</span>
<span class="sd">                &quot;job_type&quot;: &quot;ingest_journal&quot;,</span>
<span class="sd">                &quot;name&quot;: &quot;JOB-ingest_journal-test.pdf&quot;</span>
<span class="sd">                &quot;state&quot;: &quot;success&quot;,</span>
<span class="sd">                &quot;task_ids&quot;: [</span>
<span class="sd">                    &quot;55614d2e-e442-46f8-8708-029c8e83c37f&quot;,</span>
<span class="sd">                    &quot;92ef0e6e-f54c-4bd0-8079-08353d8ed3ea&quot;,</span>
<span class="sd">                    &quot;e80224ec-e80f-456d-a02d-0d330f106454&quot;,</span>
<span class="sd">                    &quot;feaa2a85-edc7-4d55-9a07-1940946445bb&quot;,</span>
<span class="sd">                    &quot;c1c554d5-a37b-4342-80b3-a5cdecab652c&quot;,</span>
<span class="sd">                    &quot;71c634ed-fe73-4e2e-8f60-ce92109c3dcd&quot;,</span>
<span class="sd">                    &quot;bb073bbe-1489-495f-9bb2-80343a6f2160&quot;,</span>
<span class="sd">                    &quot;fd393611-c344-4ed2-b090-ee8b95a337ec&quot;,</span>
<span class="sd">                    &quot;7b8eceec-aab5-4edf-8a2b-d38981a07911&quot;,</span>
<span class="sd">                    &quot;6a4f5fe6-6e25-4151-b114-548473f85f82&quot;,</span>
<span class="sd">                    &quot;484f9623-2ae0-4969-b513-4f99dab1486e&quot;,</span>
<span class="sd">                    &quot;147b74cc-dc4d-11e8-8db4-0242ac130008&quot;</span>
<span class="sd">                ],</span>
<span class="sd">                &quot;updated&quot;: &quot;Tue, 30 Oct 2018 14:07:17 GMT&quot;,</span>
<span class="sd">                &quot;user&quot;: &quot;test_user&quot;</span>
<span class="sd">            }</span>
<span class="sd">        ]</span>

<span class="sd">    :query show_all_jobs: (optional) if &#39;True&#39;, all jobs are listed</span>
<span class="sd">    :return: A JSON object containing the list of job objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">()</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="n">job_db</span><span class="o">.</span><span class="n">get_jobs_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">show_all_jobs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_all_jobs&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">show_all_jobs</span><span class="p">:</span>
        <span class="n">threshold_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OLD_JOBS_THRESHOLD_DAYS&#39;</span><span class="p">])</span>
        <span class="n">threshold_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span>
                          <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">threshold_days</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold_date</span> <span class="ow">or</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">jobs</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>


<div class="viewcode-block" id="job_create"><a class="viewcode-back" href="../../../service.job.html#service.job.job_controller.job_create">[docs]</a><span class="nd">@job_controller</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;job_type&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@auth</span><span class="o">.</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">job_create</span><span class="p">(</span><span class="n">job_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a job of the specified job type.</span>

<span class="sd">    A task chain is constructed as defined in the corresponding job type</span>
<span class="sd">    definition YAML file and executed.</span>

<span class="sd">    Parameters can be provided as JSON objects as part of the request body</span>
<span class="sd">    and must match the parameters defined in the corresponding job config YAML.</span>

<span class="sd">    Valid user credential have to be given via HTTP basic authentication.</span>

<span class="sd">    Also adds the job to the job database.</span>

<span class="sd">    .. :quickref: Job Controller; Create a job of the specified job type</span>

<span class="sd">    **Example request**:</span>

<span class="sd">    .. sourcecode:: http</span>

<span class="sd">      POST /job/&lt;job-type&gt; HTTP/1.1</span>

<span class="sd">        {</span>
<span class="sd">            &quot;metadata&quot;: {</span>
<span class="sd">                &quot;volume&quot;: &quot;&quot;,</span>
<span class="sd">                &quot;year&quot;: 2018,</span>
<span class="sd">                &quot;number&quot;: &quot;&quot;,</span>
<span class="sd">                &quot;description&quot;: &quot;[PDFs teilweise verfugbar]&quot;,</span>
<span class="sd">                &quot;importFilePath&quot;: &quot;test.pdf&quot;,</span>
<span class="sd">                &quot;identification&quot;: &quot;year&quot;</span>
<span class="sd">            },</span>
<span class="sd">            &quot;files&quot;: [{</span>
<span class="sd">                &quot;file&quot;: &quot;test.pdf&quot;,</span>
<span class="sd">                &quot;range&quot;: [</span>
<span class="sd">                    1,</span>
<span class="sd">                    5</span>
<span class="sd">                ]</span>
<span class="sd">            }],</span>
<span class="sd">            &quot;parts&quot;: [{</span>
<span class="sd">                    &quot;metadata&quot;: {</span>
<span class="sd">                        &quot;title&quot;: &quot;Ein kleines Musterdokument&quot;,</span>
<span class="sd">                        &quot;abstract&quot;: &quot;Bachelorarbeit&quot;,</span>
<span class="sd">                        &quot;author&quot;: [{</span>
<span class="sd">                            &quot;firstname&quot;: &quot;Erich &quot;,</span>
<span class="sd">                            &quot;lastname&quot;: &quot;Mustermann&quot;</span>
<span class="sd">                        }],</span>
<span class="sd">                        &quot;pages&quot;: {</span>
<span class="sd">                            &quot;showndesc&quot;: &quot;101320&quot;,</span>
<span class="sd">                            &quot;startPrint&quot;: 1,</span>
<span class="sd">                            &quot;endPrint&quot;: 2</span>
<span class="sd">                        },</span>
<span class="sd">                        &quot;date_published&quot;: &quot;2018--&quot;,</span>
<span class="sd">                        &quot;language&quot;: &quot;de_DE&quot;,</span>
<span class="sd">                        &quot;zenonId&quot;: &quot;&quot;,</span>
<span class="sd">                        &quot;auto_publish&quot;: true,</span>
<span class="sd">                        &quot;create_frontpage&quot;: false</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;files&quot;: [{</span>
<span class="sd">                        &quot;file&quot;: &quot;test.pdf&quot;,</span>
<span class="sd">                        &quot;range&quot;: [</span>
<span class="sd">                            1,</span>
<span class="sd">                            2</span>
<span class="sd">                        ]</span>
<span class="sd">                    }]</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;metadata&quot;: {</span>
<span class="sd">                        &quot;title&quot;: &quot;Titel 2&quot;,</span>
<span class="sd">                        &quot;author&quot;: [{</span>
<span class="sd">                            &quot;firstname&quot;: &quot;Autor&quot;,</span>
<span class="sd">                            &quot;lastname&quot;: &quot;Dererste&quot;</span>
<span class="sd">                        }],</span>
<span class="sd">                        &quot;pages&quot;: {</span>
<span class="sd">                            &quot;showndesc&quot;: &quot;2101327&quot;,</span>
<span class="sd">                            &quot;startPrint&quot;: 21,</span>
<span class="sd">                            &quot;endPrint&quot;: 23</span>
<span class="sd">                        },</span>
<span class="sd">                        &quot;date_published&quot;: &quot;2018--&quot;,</span>
<span class="sd">                        &quot;language&quot;: &quot;de_DE&quot;,</span>
<span class="sd">                        &quot;zenonId&quot;: &quot;&quot;,</span>
<span class="sd">                        &quot;auto_publish&quot;: true,</span>
<span class="sd">                        &quot;create_frontpage&quot;: false</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;files&quot;: [{</span>
<span class="sd">                        &quot;file&quot;: &quot;test.pdf&quot;,</span>
<span class="sd">                        &quot;range&quot;: [</span>
<span class="sd">                            21,</span>
<span class="sd">                            23</span>
<span class="sd">                        ]</span>
<span class="sd">                    }]</span>
<span class="sd">                }</span>
<span class="sd">            ],</span>
<span class="sd">            &quot;nlp_params&quot;: {</span>
<span class="sd">                &quot;lang&quot;: &quot;de&quot;</span>
<span class="sd">            },</span>
<span class="sd">            &quot;ojs_metadata&quot;: {</span>
<span class="sd">                &quot;ojs_journal_code&quot;: &quot;test&quot;,</span>
<span class="sd">                &quot;ojs_user&quot;: &quot;ojs_user&quot;,</span>
<span class="sd">                &quot;auto_publish_issue&quot;: false,</span>
<span class="sd">                &quot;default_publish_articles&quot;: true,</span>
<span class="sd">                &quot;default_create_frontpage&quot;: true,</span>
<span class="sd">                &quot;allow_upload_without_file&quot;: false</span>
<span class="sd">            },</span>
<span class="sd">            &quot;do_ocr&quot;: false</span>
<span class="sd">        }</span>


<span class="sd">    **Example response SUCCESS**:</span>

<span class="sd">    .. sourcecode:: http</span>

<span class="sd">        HTTP/1.1 200 OK</span>

<span class="sd">        {</span>
<span class="sd">            &quot;success&quot;: true,</span>
<span class="sd">            &quot;job_id&quot;: &quot;010819cc-dc4d-11e8-b152-0242ac130008&quot;,</span>
<span class="sd">            &quot;status&quot;: &quot;Accepted&quot;,</span>
<span class="sd">            &quot;task_ids&quot;: [</span>
<span class="sd">                &quot;9331a617-d35f-4b1a-be24-ec7a970c480e&quot;,</span>
<span class="sd">                &quot;f012ef11-1ac0-4810-986a-c31335b918fb&quot;,</span>
<span class="sd">                &quot;628abc60-2767-484a-a5c3-0b5a9c1a1ef6&quot;,</span>
<span class="sd">                &quot;c2a97fd1-28d2-4e97-b41f-67b6f70d91df&quot;,</span>
<span class="sd">                &quot;85cd98a7-fe3f-4e42-91f8-504c074be263&quot;,</span>
<span class="sd">                &quot;5af3a39c-f837-41df-8a5e-ecdc55a2bef6&quot;,</span>
<span class="sd">                &quot;2576d860-b694-4d41-8190-092f45837c37&quot;,</span>
<span class="sd">                &quot;8b7e956a-2fc1-446f-9cc8-9f1d63471b2a&quot;,</span>
<span class="sd">                &quot;d2d337a7-f346-4b7e-b1f8-4ee4942716f5&quot;,</span>
<span class="sd">                &quot;94304191-45fd-45f0-937c-02a6b13fb64c&quot;,</span>
<span class="sd">                &quot;b283d505-4174-4a46-909a-1f742dad6047&quot;,</span>
<span class="sd">                &quot;010819cc-dc4d-11e8-b152-0242ac130008&quot;</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>

<span class="sd">    **Example response ERROR**:</span>

<span class="sd">    .. sourcecode:: http</span>

<span class="sd">        HTTP/1.1 400 BAD REQUEST</span>

<span class="sd">            {</span>
<span class="sd">                &quot;error&quot;: {</span>
<span class="sd">                    &quot;code&quot;: &quot;bad_request&quot;,</span>
<span class="sd">                    &quot;message&quot;: &quot;400 Bad Request: The browser (or proxy)</span>
<span class="sd">                                sent a request that this server could</span>
<span class="sd">                                not understand.&quot;</span>
<span class="sd">                },</span>
<span class="sd">                &quot;success&quot;: false</span>
<span class="sd">            }</span>

<span class="sd">    :reqheader Accept: application/json</span>
<span class="sd">    :param str job_type: name of the job type</span>
<span class="sd">    :&lt;json dict metadata: descriptive data of the issue/book</span>
<span class="sd">    :&lt;json dict files: files containing the raw data</span>
<span class="sd">    :&lt;json dict parts: metadata for sub-parts</span>
<span class="sd">    :&lt;json dict nlp_params: NLP instructions</span>
<span class="sd">    :&lt;json dict ojs_metadata: OJS specific metadata</span>
<span class="sd">    :&lt;json string do_ocr: switch for OCR execution</span>

<span class="sd">    :resheader Content-Type: application/json</span>
<span class="sd">    :&gt;json dict: operation result</span>
<span class="sd">    :status 200: OK</span>

<span class="sd">    :return: A JSON object containing the status, the job id and the task ids</span>
<span class="sd">        of every subtask in the chain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ApiError</span><span class="p">(</span><span class="s2">&quot;invalid_job_params&quot;</span><span class="p">,</span> <span class="s2">&quot;No request payload found&quot;</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CONFIG_DIR&#39;</span><span class="p">],</span>
                                       <span class="s1">&#39;job_types&#39;</span><span class="p">,</span> <span class="n">job_type</span> <span class="o">+</span> <span class="s1">&#39;.yml&#39;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">ApiError</span><span class="p">(</span><span class="s2">&quot;unknown_job_type&quot;</span><span class="p">,</span> <span class="s2">&quot;No job definition file found&quot;</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_validation</span><span class="o">.</span><span class="n">validate_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">job_type</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ApiError</span><span class="p">(</span><span class="s2">&quot;unknown_job_type&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ApiError</span><span class="p">(</span><span class="s2">&quot;invalid_job_params&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">()</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">get_job_config</span><span class="p">()</span><span class="o">.</span><span class="n">generate_job</span><span class="p">(</span><span class="n">job_type</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;created job with id: </span><span class="si">{task.id}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">job_id</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span>
    <span class="n">task_ids</span> <span class="o">=</span> <span class="n">_get_task_ids</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="n">job_db</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">task_ids</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="n">body</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;Accepted&#39;</span><span class="p">,</span>
        <span class="s1">&#39;job_id&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
        <span class="s1">&#39;task_ids&#39;</span><span class="p">:</span> <span class="n">task_ids</span>
        <span class="p">})</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;job.job_status&#39;</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">body</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="n">headers</span></div>


<div class="viewcode-block" id="job_status"><a class="viewcode-back" href="../../../service.job.html#service.job.job_controller.job_status">[docs]</a><span class="nd">@job_controller</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;job_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the status information for a job.</span>

<span class="sd">    Also looks up the job  in the job database to get the name.</span>

<span class="sd">    This function is also used to get task status. Those cannot be found in the</span>
<span class="sd">    job database (as it only holds job info) and no further info will be</span>
<span class="sd">    returned.</span>

<span class="sd">    .. :quickref: Job Controller; Status information for a job</span>

<span class="sd">    **Example request**:</span>

<span class="sd">    .. sourcecode:: http</span>

<span class="sd">      GET /job/&lt;job-id&gt; HTTP/1.1</span>

<span class="sd">    **Example response**:</span>

<span class="sd">    .. sourcecode:: http</span>

<span class="sd">        HTTP/1.1 200 OK</span>

<span class="sd">        {</span>
<span class="sd">            &quot;result&quot;: {</span>
<span class="sd">                &quot;object_id&quot;: &quot;issue-test-1&quot;</span>
<span class="sd">            },</span>
<span class="sd">            &quot;status&quot;: &quot;SUCCESS&quot;,</span>
<span class="sd">            &quot;type&quot;: &quot;ingest_book&quot;</span>
<span class="sd">        }</span>

<span class="sd">    :reqheader Accept: application/json</span>
<span class="sd">    :param str job_id: Job ID</span>

<span class="sd">    :resheader Content-Type: application/json</span>
<span class="sd">    :&gt;json dict: operation result</span>
<span class="sd">    :status 200: OK</span>

<span class="sd">    :return: A JSON object containing the status info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">celery_app</span><span class="o">.</span><span class="n">AsyncResult</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">job_db</span><span class="o">.</span><span class="n">get_job_by_id</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="p">:</span>  <span class="c1"># simple task, not a job</span>
        <span class="n">job</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;SUCCESS&#39;</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">job</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
            <span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
        <span class="o">**</span><span class="n">job</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">):</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_task_ids</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">task_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">task</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">task_ids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">return</span> <span class="n">task_ids</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Cilantro</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, DAI WissIT.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>